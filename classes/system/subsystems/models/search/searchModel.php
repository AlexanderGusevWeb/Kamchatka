<?php
use UmiCms\Service;class searchModel extends singleton implements iSingleton, iSearchModel {protected function __construct() {}public static function getInstance($v4a8a08f09d37b73795649038408b5f33 = NULL) {return parent::getInstance(__CLASS__);}public function index_all($vaa9f73eea60a006820d0f8768bc8a3fc = false, $ve4f9a63df3b81b4ed1a414f12da04a6e = 0) {$vfbb44b4487415b134bce9c790a27fe5e = 0;$ve4f9a63df3b81b4ed1a414f12da04a6e = (int) $ve4f9a63df3b81b4ed1a414f12da04a6e;$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$vac5c74b64b4b8352ef2f181affb5ac2a = "SELECT id, updatetime FROM cms3_hierarchy WHERE is_deleted = '0' AND is_active = '1' AND id > '{$ve4f9a63df3b81b4ed1a414f12da04a6e}' ORDER BY id";if (is_numeric($vaa9f73eea60a006820d0f8768bc8a3fc)) {$vac5c74b64b4b8352ef2f181affb5ac2a .= ' LIMIT ' . (int) $vaa9f73eea60a006820d0f8768bc8a3fc;}$result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ROW);foreach ($result as $vf1965a857bc285d26fe22023aa5ab50d) {list($v7057e8409c7c531a1a6e9ac3df4ed549, $v3e04dc2abd929a9d02e2e0fa41d24bf9) = $vf1965a857bc285d26fe22023aa5ab50d;++$vfbb44b4487415b134bce9c790a27fe5e;$ve4f9a63df3b81b4ed1a414f12da04a6e = $v7057e8409c7c531a1a6e9ac3df4ed549;if (!$this->elementIsReindexed($v7057e8409c7c531a1a6e9ac3df4ed549, $v3e04dc2abd929a9d02e2e0fa41d24bf9)) {$this->index_item($v7057e8409c7c531a1a6e9ac3df4ed549, true);}}$vac5c74b64b4b8352ef2f181affb5ac2a = 'SELECT COUNT(`rel_id`) FROM `cms3_search`';$ve2942a04780e223b215eb8b663cf5353 = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$ve2942a04780e223b215eb8b663cf5353->setFetchType(IQueryResult::FETCH_ROW);$v43b5c9175984c071f30b873fdce0a000 = false;if ($result->length() > 0) {$v54851b009c5c647ca3e77cc517b8c76c = $ve2942a04780e223b215eb8b663cf5353->fetch();$v43b5c9175984c071f30b873fdce0a000 = array_shift($v54851b009c5c647ca3e77cc517b8c76c);}return [    'current' => $v43b5c9175984c071f30b873fdce0a000,    'lastId' => $ve4f9a63df3b81b4ed1a414f12da04a6e   ];}public function index_item($v7552cd149af7495ee7d8225974e50f80, $v9cec682aae64c77617c76d61e147a452 = false) {if (defined('DISABLE_SEARCH_REINDEX') && !$v9cec682aae64c77617c76d61e147a452) {return false;}$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$v4717d53ebfdfea8477f780ec66151dcb->startTransaction("Indexing element #{$v7552cd149af7495ee7d8225974e50f80}");try {$vec5463c0e508eaa43548444d87ab2e83 = $this->parseItem($v7552cd149af7495ee7d8225974e50f80);}catch (Exception $ve1671797c52e15f763380b45e841ec32) {$v4717d53ebfdfea8477f780ec66151dcb->rollbackTransaction();throw $ve1671797c52e15f763380b45e841ec32;}$v4717d53ebfdfea8477f780ec66151dcb->commitTransaction();return $vec5463c0e508eaa43548444d87ab2e83;}public function processPage(iUmiHierarchyElement $v8e2dcfd7e7e24b1ca76c1193f645902b) {if ($this->isAllowed($v8e2dcfd7e7e24b1ca76c1193f645902b)) {$this->index_item($v8e2dcfd7e7e24b1ca76c1193f645902b->getId());}else {$this->unindex_items($v8e2dcfd7e7e24b1ca76c1193f645902b->getId());}return $this;}public function processPageList(array $v8bde57434adb7a78cc31875b6e82f43e) {array_map([$this, 'processPage'], $v8bde57434adb7a78cc31875b6e82f43e);return $this;}public function parseItem($v7057e8409c7c531a1a6e9ac3df4ed549) {$v7057e8409c7c531a1a6e9ac3df4ed549 = (int) $v7057e8409c7c531a1a6e9ac3df4ed549;$v8e2dcfd7e7e24b1ca76c1193f645902b = umiHierarchy::getInstance()->getElement($v7057e8409c7c531a1a6e9ac3df4ed549, true, true);if (!$v8e2dcfd7e7e24b1ca76c1193f645902b instanceof iUmiHierarchyElement || !$this->isAllowed($v8e2dcfd7e7e24b1ca76c1193f645902b)) {return false;}$v9d1be7b20c9b43741bbda33a93ae2597 = [];$v94757cae63fd3e398c0811a976dd6bbe = $v8e2dcfd7e7e24b1ca76c1193f645902b->getObjectTypeId();$v599dcce2998a6b40b1e38e8c6006cb0a = umiObjectTypesCollection::getInstance()->getType($v94757cae63fd3e398c0811a976dd6bbe);$vb308737ea9e2bcc45fd2bf20dc6c7d45 = $v599dcce2998a6b40b1e38e8c6006cb0a->getFieldsGroupsList();foreach ($vb308737ea9e2bcc45fd2bf20dc6c7d45 as $v6c26c1979a522c2dd7e76e527aa69ca5 => $v38f582e54454005ec0664831734e1152) {foreach ($v38f582e54454005ec0664831734e1152->getFields() as $v3aabf39f2d943fa886d86dcbbee4d910 => $v06e3d36fa30cea095545139854ad1fb9) {$v17f71d965fe9589ddbd11caf7182243e = $v06e3d36fa30cea095545139854ad1fb9->getFieldType()->getDataType();if (!$v06e3d36fa30cea095545139854ad1fb9->getIsInSearch() || $v17f71d965fe9589ddbd11caf7182243e == 'optioned') {continue;}$v73f329f154a663bfda020aadcdd0b775 = $v06e3d36fa30cea095545139854ad1fb9->getName();$v3a6d0284e743dc4a9b86f97d6dd1a3bf = $v8e2dcfd7e7e24b1ca76c1193f645902b->getValue($v73f329f154a663bfda020aadcdd0b775);if ($v17f71d965fe9589ddbd11caf7182243e) {if (is_array($v3a6d0284e743dc4a9b86f97d6dd1a3bf)) {if ($v17f71d965fe9589ddbd11caf7182243e == 'relation') {foreach ($v3a6d0284e743dc4a9b86f97d6dd1a3bf as $v865c0c0b4ab0e063e5caa3387c1a8741 => $v9e3669d19b675bd57058fd4664205d2a) {$v447b7147e84be512208dcc0995d67ebc = selector::get('object')->id($v9e3669d19b675bd57058fd4664205d2a);if ($v447b7147e84be512208dcc0995d67ebc) {$v3a6d0284e743dc4a9b86f97d6dd1a3bf[$v865c0c0b4ab0e063e5caa3387c1a8741] = $v447b7147e84be512208dcc0995d67ebc->getName();unset($v447b7147e84be512208dcc0995d67ebc);}}}$v3a6d0284e743dc4a9b86f97d6dd1a3bf = implode(' ', $v3a6d0284e743dc4a9b86f97d6dd1a3bf);}else {if(is_object($v3a6d0284e743dc4a9b86f97d6dd1a3bf)) {continue;}if($v17f71d965fe9589ddbd11caf7182243e == 'relation') {$v447b7147e84be512208dcc0995d67ebc = selector::get('object')->id($v3a6d0284e743dc4a9b86f97d6dd1a3bf);if($v447b7147e84be512208dcc0995d67ebc) {$v3a6d0284e743dc4a9b86f97d6dd1a3bf = $v447b7147e84be512208dcc0995d67ebc->getName();}}}}if ($v3a6d0284e743dc4a9b86f97d6dd1a3bf === null || !$v3a6d0284e743dc4a9b86f97d6dd1a3bf) {continue;}$v3a6d0284e743dc4a9b86f97d6dd1a3bf = preg_replace('/%([A-z_]*)%/m', '', $v3a6d0284e743dc4a9b86f97d6dd1a3bf);$v3a6d0284e743dc4a9b86f97d6dd1a3bf = preg_replace("/%([A-zЂ-пРђ-СЏ \/\._\-\(\)0-9%:<>,!@\|'&=;\?\+#]*)%/m", '', $v3a6d0284e743dc4a9b86f97d6dd1a3bf);$v9d1be7b20c9b43741bbda33a93ae2597[$v73f329f154a663bfda020aadcdd0b775] = $v3a6d0284e743dc4a9b86f97d6dd1a3bf;}}$v9f1c8757350ffe06fffc7cc4b03150af = $this->buildIndexImage($v9d1be7b20c9b43741bbda33a93ae2597);$this->updateSearchIndex($v7057e8409c7c531a1a6e9ac3df4ed549, $v9f1c8757350ffe06fffc7cc4b03150af);}public function buildIndexImage($v5308cca1be08c0bdbdfd06290ce5bed2) {$vb798abe6e1b1318ee36b0dcb3fb9e4d3 = [];$v63f4f1e9b725370f459720575cd5f953 = [    'h1' => 5,    'title' => 5,    'meta_keywords' => 3,    'meta_descriptions' => 3,    'tags' => 3   ];foreach ($v5308cca1be08c0bdbdfd06290ce5bed2 as $v972bf3f05d14ffbdb817bef60638ff00 => $v341be97d9aff90c9978347f66f945b77) {$v47c80780ab608cc046f2a6e6f071feb6 = $this->splitString($v341be97d9aff90c9978347f66f945b77);if (isset($v63f4f1e9b725370f459720575cd5f953[$v972bf3f05d14ffbdb817bef60638ff00])) {$v7edabf994b76a00cbc60c95af337db8f = (int) $v63f4f1e9b725370f459720575cd5f953[$v972bf3f05d14ffbdb817bef60638ff00];}else {$v7edabf994b76a00cbc60c95af337db8f = 1;}foreach ($v47c80780ab608cc046f2a6e6f071feb6 as $vc47d187067c6cf953245f128b5fde62a)  {if (array_key_exists($vc47d187067c6cf953245f128b5fde62a, $vb798abe6e1b1318ee36b0dcb3fb9e4d3)) {$vb798abe6e1b1318ee36b0dcb3fb9e4d3[$vc47d187067c6cf953245f128b5fde62a] += $v7edabf994b76a00cbc60c95af337db8f;}else {$vb798abe6e1b1318ee36b0dcb3fb9e4d3[$vc47d187067c6cf953245f128b5fde62a] = $v7edabf994b76a00cbc60c95af337db8f;}}}return $vb798abe6e1b1318ee36b0dcb3fb9e4d3;}public static function splitString($v341be97d9aff90c9978347f66f945b77) {if (!is_string($v341be97d9aff90c9978347f66f945b77)) {return [];}$v29a6859860d0f35ec9a976557ce6923c = [    '&nbsp;',    '&quote;',    '. ',    ', ',    ' .',    ' ,',    '?',    ':',    ';',    '%',    ')',    '(',    '/',    '<',    '>',    '- ',    ' -',    '«',    '»'   ];$v341be97d9aff90c9978347f66f945b77 = str_replace('>', '> ', $v341be97d9aff90c9978347f66f945b77);$v341be97d9aff90c9978347f66f945b77 = str_replace('"', ' ', $v341be97d9aff90c9978347f66f945b77);$v341be97d9aff90c9978347f66f945b77 = strip_tags($v341be97d9aff90c9978347f66f945b77);$v341be97d9aff90c9978347f66f945b77 = str_replace($v29a6859860d0f35ec9a976557ce6923c, ' ', $v341be97d9aff90c9978347f66f945b77);$v341be97d9aff90c9978347f66f945b77 = preg_replace("/([ \t\r\n]{1-100})/u", ' ', $v341be97d9aff90c9978347f66f945b77);$v341be97d9aff90c9978347f66f945b77 = mb_strtolower($v341be97d9aff90c9978347f66f945b77);$vfa816edb83e95bf0c8da580bdfd491ef = explode(' ', $v341be97d9aff90c9978347f66f945b77);$v9b207167e5381c47682c6b4f58a623fb = [];foreach ($vfa816edb83e95bf0c8da580bdfd491ef as $v9e3669d19b675bd57058fd4664205d2a) {$v9b207167e5381c47682c6b4f58a623fb[] = trim($v9e3669d19b675bd57058fd4664205d2a);}return $v9b207167e5381c47682c6b4f58a623fb;}public function updateSearchIndex($v7057e8409c7c531a1a6e9ac3df4ed549, $v9f1c8757350ffe06fffc7cc4b03150af) {$v8e2dcfd7e7e24b1ca76c1193f645902b = umiHierarchy::getInstance()->getElement($v7057e8409c7c531a1a6e9ac3df4ed549, true);if (!$v8e2dcfd7e7e24b1ca76c1193f645902b instanceof iUmiHierarchyElement) {return false;}$v662cbf1253ac7d8750ed9190c52163e5 = $v8e2dcfd7e7e24b1ca76c1193f645902b->getDomainId();$v78e6dd7a49f5b0cb2106a3a434dd5c86 = $v8e2dcfd7e7e24b1ca76c1193f645902b->getLangId();$v94757cae63fd3e398c0811a976dd6bbe = $v8e2dcfd7e7e24b1ca76c1193f645902b->getTypeId();$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$vac5c74b64b4b8352ef2f181affb5ac2a = "SELECT `rel_id` FROM `cms3_search` WHERE `rel_id` = '{$v7057e8409c7c531a1a6e9ac3df4ed549}' LIMIT 0,1";$v26d59e24afcb9c11f03ffe8392b68734 = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$v26d59e24afcb9c11f03ffe8392b68734->setFetchType(IQueryResult::FETCH_ROW);if ($v26d59e24afcb9c11f03ffe8392b68734->length() == 0) {$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
INSERT INTO cms3_search (rel_id, domain_id, lang_id, type_id) 
VALUES('{$v7057e8409c7c531a1a6e9ac3df4ed549}', '{$v662cbf1253ac7d8750ed9190c52163e5}', '{$v78e6dd7a49f5b0cb2106a3a434dd5c86}', '{$v94757cae63fd3e398c0811a976dd6bbe}')
SQL;    $v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);}$vac5c74b64b4b8352ef2f181affb5ac2a = "DELETE FROM cms3_search_index WHERE rel_id = '{$v7057e8409c7c531a1a6e9ac3df4ed549}'";$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);$vac5c74b64b4b8352ef2f181affb5ac2a = 'INSERT INTO cms3_search_index (rel_id, weight, word_id, tf) VALUES ';$v7b8b965ad4bca0e41ab51de7b31363a1 = 0;$vb29c3fd06b2e60bd082b5378410d9171 = array_sum($v9f1c8757350ffe06fffc7cc4b03150af);foreach ($v9f1c8757350ffe06fffc7cc4b03150af as $vc47d187067c6cf953245f128b5fde62a => $v7edabf994b76a00cbc60c95af337db8f) {$v83ca49d02d735958e354492a19f076b0 = $this->getWordId($vc47d187067c6cf953245f128b5fde62a);if (!$v83ca49d02d735958e354492a19f076b0) {continue;}$vc3ee2af7ca7bbe492f11cf36a6a7cea7 = $v7edabf994b76a00cbc60c95af337db8f / $vb29c3fd06b2e60bd082b5378410d9171;$vac5c74b64b4b8352ef2f181affb5ac2a .= "('{$v7057e8409c7c531a1a6e9ac3df4ed549}', '{$v7edabf994b76a00cbc60c95af337db8f}', '{$v83ca49d02d735958e354492a19f076b0}', '{$vc3ee2af7ca7bbe492f11cf36a6a7cea7}'), ";++$v7b8b965ad4bca0e41ab51de7b31363a1;}if ($v7b8b965ad4bca0e41ab51de7b31363a1) {$vac5c74b64b4b8352ef2f181affb5ac2a = mb_substr($vac5c74b64b4b8352ef2f181affb5ac2a, 0, mb_strlen($vac5c74b64b4b8352ef2f181affb5ac2a) - 2);$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);}$v07cc694b9b3fc636710fa08b6922c42b = time();$vac5c74b64b4b8352ef2f181affb5ac2a = "UPDATE cms3_search SET indextime = '{$v07cc694b9b3fc636710fa08b6922c42b}' WHERE rel_id = '{$v7057e8409c7c531a1a6e9ac3df4ed549}'";$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);umiHierarchy::getInstance()->unloadElement($v7057e8409c7c531a1a6e9ac3df4ed549);return true;}public static function getWordId($vc47d187067c6cf953245f128b5fde62a) {$vc47d187067c6cf953245f128b5fde62a = trim($vc47d187067c6cf953245f128b5fde62a, "\r\n\t? ;.,!@#$%^&*()_+-=\\/:<>{}[]'\"`~|");$vc47d187067c6cf953245f128b5fde62a = mb_strtolower($vc47d187067c6cf953245f128b5fde62a);if (mb_strlen($vc47d187067c6cf953245f128b5fde62a) < 3) {return false;}$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$vc47d187067c6cf953245f128b5fde62a = $v4717d53ebfdfea8477f780ec66151dcb->escape($vc47d187067c6cf953245f128b5fde62a);$vac5c74b64b4b8352ef2f181affb5ac2a = "SELECT id FROM cms3_search_index_words WHERE word = '{$vc47d187067c6cf953245f128b5fde62a}'";$result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ROW);if ($result->length() > 0) {$v54851b009c5c647ca3e77cc517b8c76c = $result->fetch();return array_shift($v54851b009c5c647ca3e77cc517b8c76c);}$vac5c74b64b4b8352ef2f181affb5ac2a = "INSERT INTO cms3_search_index_words (word) VALUES('{$vc47d187067c6cf953245f128b5fde62a}')";$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);return (int) $v4717d53ebfdfea8477f780ec66151dcb->insertId();}public function getIndexPages() {$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$vac5c74b64b4b8352ef2f181affb5ac2a = 'SELECT SQL_SMALL_RESULT COUNT(*) FROM cms3_search';$result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ROW);$ve2942a04780e223b215eb8b663cf5353 = 0;if ($result->length() > 0) {$v54851b009c5c647ca3e77cc517b8c76c = $result->fetch();$ve2942a04780e223b215eb8b663cf5353 = (int) array_shift($v54851b009c5c647ca3e77cc517b8c76c);}return (int) $ve2942a04780e223b215eb8b663cf5353;}public function getAllIndexablePages() {$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$v1b1cc7f086b3f074da452bc3129981eb = new selector('pages');$veaa33017ffd2f7f97cff2f2da31548df = (int) $v1b1cc7f086b3f074da452bc3129981eb->searchField('is_unindexed', true);$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT COUNT(DISTINCT h.obj_id)
FROM cms3_hierarchy h, cms3_objects o
LEFT JOIN cms3_object_content c ON c.obj_id=o.id AND c.field_id = $veaa33017ffd2f7f97cff2f2da31548df
WHERE 
c.int_val IS NULL AND 
h.is_deleted = '' AND 
h.is_active = '1' AND 
h.obj_id = o.id
SQL;   $result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ROW);$ve2942a04780e223b215eb8b663cf5353 = 0;if ($result->length() > 0) {$v54851b009c5c647ca3e77cc517b8c76c = $result->fetch();$ve2942a04780e223b215eb8b663cf5353 = (int) array_shift($v54851b009c5c647ca3e77cc517b8c76c);}return (int) $ve2942a04780e223b215eb8b663cf5353;}public function getIndexWords() {$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$vac5c74b64b4b8352ef2f181affb5ac2a = 'SELECT SQL_SMALL_RESULT SUM(weight) FROM cms3_search_index';$result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ROW);$ve2942a04780e223b215eb8b663cf5353 = 0;if ($result->length() > 0) {$v54851b009c5c647ca3e77cc517b8c76c = $result->fetch();$ve2942a04780e223b215eb8b663cf5353 = (int) array_shift($v54851b009c5c647ca3e77cc517b8c76c);}return (int) $ve2942a04780e223b215eb8b663cf5353;}public function getIndexWordsUniq() {$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$vac5c74b64b4b8352ef2f181affb5ac2a = 'SELECT SQL_SMALL_RESULT COUNT(*) FROM cms3_search_index_words';$result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ROW);$ve2942a04780e223b215eb8b663cf5353 = 0;if ($result->length() > 0) {$v54851b009c5c647ca3e77cc517b8c76c = $result->fetch();$ve2942a04780e223b215eb8b663cf5353 = (int) array_shift($v54851b009c5c647ca3e77cc517b8c76c);}return (int) $ve2942a04780e223b215eb8b663cf5353;}public function getIndexLast() {$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$vac5c74b64b4b8352ef2f181affb5ac2a = 'SELECT SQL_SMALL_RESULT indextime FROM cms3_search ORDER BY indextime DESC LIMIT 1';$result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ROW);$ve2942a04780e223b215eb8b663cf5353 = 0;if ($result->length() > 0) {$v54851b009c5c647ca3e77cc517b8c76c = $result->fetch();$ve2942a04780e223b215eb8b663cf5353 = (int) array_shift($v54851b009c5c647ca3e77cc517b8c76c);}return (int) $ve2942a04780e223b215eb8b663cf5353;}public function truncate_index () {$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$vac5c74b64b4b8352ef2f181affb5ac2a = 'TRUNCATE TABLE cms3_search_index_words';$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);$vac5c74b64b4b8352ef2f181affb5ac2a = 'TRUNCATE TABLE cms3_search_index';$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);$vac5c74b64b4b8352ef2f181affb5ac2a = 'TRUNCATE TABLE cms3_search';$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);return true;}public function runSearch($v597a51f04d341eba4ca965899acc10b3, $v14236557f2d0162089c57597074399ac = NULL, $v06eba0c81e2c853a3850d7d920570edb = NULL, $vae1d6a6518a73b480c52bcf30553f9f8 = false) {$v89759e1284e2479b991d2669de104942 = $this->splitString($v597a51f04d341eba4ca965899acc10b3);return $this->buildQueries($v89759e1284e2479b991d2669de104942, $v14236557f2d0162089c57597074399ac, $v06eba0c81e2c853a3850d7d920570edb, $vae1d6a6518a73b480c52bcf30553f9f8);}public function buildQueries($v89759e1284e2479b991d2669de104942, $vb934cdf74d9a078a5654bd8b129741d9 = NULL, $v06eba0c81e2c853a3850d7d920570edb = NULL, $vae1d6a6518a73b480c52bcf30553f9f8 = false) {$v78e6dd7a49f5b0cb2106a3a434dd5c86 = Service::LanguageDetector()->detectId();$v662cbf1253ac7d8750ed9190c52163e5 = Service::DomainDetector()->detectId();$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$v3f48301f2668ec4eec370518ddcffe63 = mainConfiguration::getInstance();$vf363554fffcbe5ed0107628b8a7452ba = $v3f48301f2668ec4eec370518ddcffe63->get('system','search-morph-disabled');$v133eb1ef2e0bd8996d929cadfa0ae35f = (int) $v3f48301f2668ec4eec370518ddcffe63->get('kernel','search-min-word-length');$v133eb1ef2e0bd8996d929cadfa0ae35f = ($v133eb1ef2e0bd8996d929cadfa0ae35f < 2) ? 2 : $v133eb1ef2e0bd8996d929cadfa0ae35f;$v904f91dd4c2326a2e35d46a8fe5cbb7c = (bool) $v3f48301f2668ec4eec370518ddcffe63->get('kernel','search-in-any-part-of-string');$v552d950018013c406012916a24ca53ef = $v904f91dd4c2326a2e35d46a8fe5cbb7c ? '%' : '';$v721023118cca90897209b50c681b3160 = [];$v4a0dbe074c347d5e9cc1702047836766 = [];foreach ($v89759e1284e2479b991d2669de104942 as $v865c0c0b4ab0e063e5caa3387c1a8741 => $vc47d187067c6cf953245f128b5fde62a) {if (mb_strlen($vc47d187067c6cf953245f128b5fde62a) < $v133eb1ef2e0bd8996d929cadfa0ae35f) {unset($v89759e1284e2479b991d2669de104942[$v865c0c0b4ab0e063e5caa3387c1a8741]);continue;}$vc47d187067c6cf953245f128b5fde62a = $v4717d53ebfdfea8477f780ec66151dcb->escape($vc47d187067c6cf953245f128b5fde62a);$vc47d187067c6cf953245f128b5fde62a = str_replace(['%', '_'], ["\\%", "\\_"], $vc47d187067c6cf953245f128b5fde62a);$v1c8b3a3ca57a0beda8c7653fd724183d = "siw.word LIKE '{$v552d950018013c406012916a24ca53ef}{$vc47d187067c6cf953245f128b5fde62a}%' ";if (!$vf363554fffcbe5ed0107628b8a7452ba)  {$v76f3c2687c1bc668f07f87b8e760cad7 = language_morph::get_word_base($vc47d187067c6cf953245f128b5fde62a);if ((mb_strlen($v76f3c2687c1bc668f07f87b8e760cad7) >= $v133eb1ef2e0bd8996d929cadfa0ae35f) && ($v76f3c2687c1bc668f07f87b8e760cad7 != $vc47d187067c6cf953245f128b5fde62a) ) {$v76f3c2687c1bc668f07f87b8e760cad7 = $v4717d53ebfdfea8477f780ec66151dcb->escape($v76f3c2687c1bc668f07f87b8e760cad7);$v1c8b3a3ca57a0beda8c7653fd724183d .= " OR siw.word LIKE '{$v552d950018013c406012916a24ca53ef}{$v76f3c2687c1bc668f07f87b8e760cad7}%'";}}$v721023118cca90897209b50c681b3160[] = '(' . $v1c8b3a3ca57a0beda8c7653fd724183d . ')';$v4a0dbe074c347d5e9cc1702047836766[] = ' WHEN (' . $v1c8b3a3ca57a0beda8c7653fd724183d . ") THEN '{$vc47d187067c6cf953245f128b5fde62a}'";}$v03ed04426fc17f79e0b77603ce6c81d3 = implode(' OR ', $v721023118cca90897209b50c681b3160);$vb0beec004a403620a08891be2d959fcd = '(CASE' . implode($v4a0dbe074c347d5e9cc1702047836766) . ' END) as search_word';if (!$v03ed04426fc17f79e0b77603ce6c81d3) {return [];}$v538df8a817542c341fb29adc5c5b165d = '';$v7b3d2a2630466b55db035bc4adc620b4 = '';$v66eaea9d57b28ed8cb924ba57362c0af = permissionsCollection::getInstance();if (!$v66eaea9d57b28ed8cb924ba57362c0af->isSv()) {$vfa53b91ccc1b78668d5af58e1ed3a485 = Service::Auth();$ve8701ad48ba05a91604e480dd60899a3 = $vfa53b91ccc1b78668d5af58e1ed3a485->getUserId();$vee11cbb19052e40b07aac0ca060c23ee = umiObjectsCollection::getInstance()->getObject($ve8701ad48ba05a91604e480dd60899a3);$v1471e4e05a4db95d353cc867fe317314 = $vee11cbb19052e40b07aac0ca060c23ee->getValue('groups');$v1471e4e05a4db95d353cc867fe317314[] = $ve8701ad48ba05a91604e480dd60899a3;$v1876714ec08549d69462e2d7617c83c8 = Service::SystemUsersPermissions();$v1471e4e05a4db95d353cc867fe317314[] = $v1876714ec08549d69462e2d7617c83c8->getGuestUserId();$v1471e4e05a4db95d353cc867fe317314 = array_extract_values($v1471e4e05a4db95d353cc867fe317314);$v1471e4e05a4db95d353cc867fe317314 = implode(', ', $v1471e4e05a4db95d353cc867fe317314);$v538df8a817542c341fb29adc5c5b165d = " AND c3p.level >= 1 AND c3p.owner_id IN({$v1471e4e05a4db95d353cc867fe317314})";$v7b3d2a2630466b55db035bc4adc620b4 = 'INNER JOIN cms3_permissions as  `c3p` ON c3p.rel_id = s.rel_id';}$v6c666917ae648d1e7ec45408bf54efc6 = '';if (is_array($vb934cdf74d9a078a5654bd8b129741d9)) {if (umiCount($vb934cdf74d9a078a5654bd8b129741d9)) {if ($vb934cdf74d9a078a5654bd8b129741d9 && $vb934cdf74d9a078a5654bd8b129741d9[0]) {$v6c666917ae648d1e7ec45408bf54efc6 = ' AND s.type_id IN (' . $v4717d53ebfdfea8477f780ec66151dcb->escape(implode(', ', $vb934cdf74d9a078a5654bd8b129741d9)) . ')';}}}$va9e49c488dc6a07200de31dbd512d69a = '';if (is_array($v06eba0c81e2c853a3850d7d920570edb) && umiCount($v06eba0c81e2c853a3850d7d920570edb)) {$va9e49c488dc6a07200de31dbd512d69a = ' AND h.rel IN (' . $v4717d53ebfdfea8477f780ec66151dcb->escape(implode(', ', $v06eba0c81e2c853a3850d7d920570edb)) . ')';}$v4717d53ebfdfea8477f780ec66151dcb->query('CREATE TEMPORARY TABLE temp_search (rel_id int unsigned, tf float, word varchar(64), search_word varchar(64))');$vac5c74b64b4b8352ef2f181affb5ac2a = <<<EOF
				INSERT INTO temp_search SELECT SQL_SMALL_RESULT HIGH_PRIORITY
					s.rel_id,
					si.weight,
					siw.word,
					$vb0beec004a403620a08891be2d959fcd
				FROM cms3_search_index_words as `siw`
					INNER JOIN cms3_search_index as `si` ON si.word_id = siw.id
					INNER JOIN cms3_search as `s` ON s.rel_id = si.rel_id
					INNER JOIN cms3_hierarchy as  `h` ON h.id = s.rel_id
					{$v7b3d2a2630466b55db035bc4adc620b4}

				WHERE
					({$v03ed04426fc17f79e0b77603ce6c81d3}) AND
					s.domain_id = '{$v662cbf1253ac7d8750ed9190c52163e5}' AND
					s.lang_id = '{$v78e6dd7a49f5b0cb2106a3a434dd5c86}' AND
					h.is_deleted = '0' AND
					h.is_active = '1'
					{$v6c666917ae648d1e7ec45408bf54efc6}
					{$va9e49c488dc6a07200de31dbd512d69a}
					{$v538df8a817542c341fb29adc5c5b165d}
				GROUP BY s.rel_id, si.weight, search_word
EOF;   $v9b207167e5381c47682c6b4f58a623fb = [];$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);if ($vae1d6a6518a73b480c52bcf30553f9f8) {$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT rel_id, SUM(tf) AS x
	FROM temp_search
		GROUP BY rel_id
			ORDER BY x DESC, rel_id DESC
SQL;   }else {$vdb9d5968645f90092f4b913cf77a9af7 = umiCount($v89759e1284e2479b991d2669de104942);$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT rel_id, SUM(tf) AS x, COUNT(word) AS wc
	FROM temp_search
		GROUP BY rel_id
			HAVING wc >= '{$vdb9d5968645f90092f4b913cf77a9af7}'
				ORDER BY x DESC, rel_id DESC
SQL;   }$result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ROW);foreach ($result as $vf1965a857bc285d26fe22023aa5ab50d) {$v9b207167e5381c47682c6b4f58a623fb[] = array_shift($vf1965a857bc285d26fe22023aa5ab50d);}$v4717d53ebfdfea8477f780ec66151dcb->query('DROP TEMPORARY TABLE IF EXISTS temp_search');return $v9b207167e5381c47682c6b4f58a623fb;}public function prepareContext($v7057e8409c7c531a1a6e9ac3df4ed549, $vcc475582f6f7e3f30f5a46236d75b6c5 = false) {if (!($v8e2dcfd7e7e24b1ca76c1193f645902b = umiHierarchy::getInstance()->getElement($v7057e8409c7c531a1a6e9ac3df4ed549))) {return false;}if ($v8e2dcfd7e7e24b1ca76c1193f645902b->getValue('is_unindexed')) {return false;}$v5c18ef72771564b7f43c497dc507aeab = [];$v94757cae63fd3e398c0811a976dd6bbe = $v8e2dcfd7e7e24b1ca76c1193f645902b->getObject()->getTypeId();$v599dcce2998a6b40b1e38e8c6006cb0a = umiObjectTypesCollection::getInstance()->getType($v94757cae63fd3e398c0811a976dd6bbe);$vb308737ea9e2bcc45fd2bf20dc6c7d45 = $v599dcce2998a6b40b1e38e8c6006cb0a->getFieldsGroupsList();foreach($vb308737ea9e2bcc45fd2bf20dc6c7d45 as $v6c26c1979a522c2dd7e76e527aa69ca5 => $v38f582e54454005ec0664831734e1152) {foreach($v38f582e54454005ec0664831734e1152->getFields() as $v3aabf39f2d943fa886d86dcbbee4d910 => $v06e3d36fa30cea095545139854ad1fb9) {if (!$v06e3d36fa30cea095545139854ad1fb9->getIsInSearch()) {continue;}$v73f329f154a663bfda020aadcdd0b775 = $v06e3d36fa30cea095545139854ad1fb9->getName();$v17f71d965fe9589ddbd11caf7182243e = $v06e3d36fa30cea095545139854ad1fb9->getFieldType()->getDataType();$v3a6d0284e743dc4a9b86f97d6dd1a3bf = $v8e2dcfd7e7e24b1ca76c1193f645902b->getValue($v73f329f154a663bfda020aadcdd0b775);if ($v17f71d965fe9589ddbd11caf7182243e == 'relation') {if (!is_array($v3a6d0284e743dc4a9b86f97d6dd1a3bf)) {$v3a6d0284e743dc4a9b86f97d6dd1a3bf = [$v3a6d0284e743dc4a9b86f97d6dd1a3bf];}foreach ($v3a6d0284e743dc4a9b86f97d6dd1a3bf as $v865c0c0b4ab0e063e5caa3387c1a8741 => $v9e3669d19b675bd57058fd4664205d2a) {$v447b7147e84be512208dcc0995d67ebc = selector::get('object')->id($v9e3669d19b675bd57058fd4664205d2a);if ($v447b7147e84be512208dcc0995d67ebc) {$v3a6d0284e743dc4a9b86f97d6dd1a3bf[$v865c0c0b4ab0e063e5caa3387c1a8741] = $v447b7147e84be512208dcc0995d67ebc->getName();}}$v3a6d0284e743dc4a9b86f97d6dd1a3bf = implode(' ', $v3a6d0284e743dc4a9b86f97d6dd1a3bf);}if ($v3a6d0284e743dc4a9b86f97d6dd1a3bf === null || !$v3a6d0284e743dc4a9b86f97d6dd1a3bf) {continue;}if(is_object($v3a6d0284e743dc4a9b86f97d6dd1a3bf)) {continue;}$v5c18ef72771564b7f43c497dc507aeab[] = $v3a6d0284e743dc4a9b86f97d6dd1a3bf;}}if ($vcc475582f6f7e3f30f5a46236d75b6c5) {$v5c18ef72771564b7f43c497dc507aeab = array_unique($v5c18ef72771564b7f43c497dc507aeab);}$v9b207167e5381c47682c6b4f58a623fb = '';foreach ($v5c18ef72771564b7f43c497dc507aeab as $v3a6d0284e743dc4a9b86f97d6dd1a3bf) {if(is_array($v3a6d0284e743dc4a9b86f97d6dd1a3bf)) {continue;}$v9b207167e5381c47682c6b4f58a623fb .= $v3a6d0284e743dc4a9b86f97d6dd1a3bf . ' ';}$v9b207167e5381c47682c6b4f58a623fb = preg_replace("/%[A-z0-9_]+ [A-z0-9_]+\([^\)]+\)%/im", '', $v9b207167e5381c47682c6b4f58a623fb);$v9b207167e5381c47682c6b4f58a623fb = str_replace('%', '&#037', $v9b207167e5381c47682c6b4f58a623fb);return $v9b207167e5381c47682c6b4f58a623fb;}public function getContext($v7552cd149af7495ee7d8225974e50f80, $v597a51f04d341eba4ca965899acc10b3) {$v9a0364b9e99bb480dd25e1f0284c8555 = $this->prepareContext($v7552cd149af7495ee7d8225974e50f80, true);$v9a0364b9e99bb480dd25e1f0284c8555 = preg_replace("/%content redirect\((.*)\)%/im", "::CONTENT_REDIRECT::\\1::", $v9a0364b9e99bb480dd25e1f0284c8555);$v9a0364b9e99bb480dd25e1f0284c8555 = preg_replace("/(%|&#037)[A-z0-9]+ [A-z0-9]+\((.*)\)(%|&#037)/im", '', $v9a0364b9e99bb480dd25e1f0284c8555);$v6920626369b1f05844f5e3d6f93b5f6e = '<b>';$v4de1b7a4dc53e4a84c25ffb7cdb580ee = '</b>';$v8836d156dbd01a6c0776b086b0ff3b83 = explode(' ', $v597a51f04d341eba4ca965899acc10b3);$v9a0364b9e99bb480dd25e1f0284c8555 = preg_replace("/([A-zА-я0-9])\.([A-zА-я0-9])/im", "\\1&#46;\\2", $v9a0364b9e99bb480dd25e1f0284c8555);$v5c18ef72771564b7f43c497dc507aeab = str_replace('>', '> ', $v9a0364b9e99bb480dd25e1f0284c8555);$v5c18ef72771564b7f43c497dc507aeab = str_replace('<br>', ' ', $v5c18ef72771564b7f43c497dc507aeab);$v5c18ef72771564b7f43c497dc507aeab = str_replace('&nbsp;', ' ', $v5c18ef72771564b7f43c497dc507aeab);$v5c18ef72771564b7f43c497dc507aeab = str_replace("\n", ' ', $v5c18ef72771564b7f43c497dc507aeab);$v5c18ef72771564b7f43c497dc507aeab = strip_tags($v5c18ef72771564b7f43c497dc507aeab);if (preg_match_all('/::CONTENT_REDIRECT::(.*)::/i', $v5c18ef72771564b7f43c497dc507aeab, $v3d801aa532c1cec3ee82d87a99fdf63f)) {$v7dabf5c198b0bab2eaa42bb03a113e55 = umiCount($v3d801aa532c1cec3ee82d87a99fdf63f[1]);for ($v865c0c0b4ab0e063e5caa3387c1a8741 = 0;$v865c0c0b4ab0e063e5caa3387c1a8741 < $v7dabf5c198b0bab2eaa42bb03a113e55;$v865c0c0b4ab0e063e5caa3387c1a8741++) {if (is_numeric($v3d801aa532c1cec3ee82d87a99fdf63f[1][$v865c0c0b4ab0e063e5caa3387c1a8741])) {$v4a0dc59dd475d7fbeadc872e24f24dd0 = umiHierarchy::getInstance()->getPathById($v3d801aa532c1cec3ee82d87a99fdf63f[1][$v865c0c0b4ab0e063e5caa3387c1a8741]);}else {$v4a0dc59dd475d7fbeadc872e24f24dd0 = strip_tags($v3d801aa532c1cec3ee82d87a99fdf63f[1][$v865c0c0b4ab0e063e5caa3387c1a8741]);}$v4a0dc59dd475d7fbeadc872e24f24dd0 = trim($v4a0dc59dd475d7fbeadc872e24f24dd0, "'");$v5c18ef72771564b7f43c497dc507aeab = str_replace($v3d801aa532c1cec3ee82d87a99fdf63f[0][$v865c0c0b4ab0e063e5caa3387c1a8741], "<p>%search_redirect_text% <a href=\"{$v4a0dc59dd475d7fbeadc872e24f24dd0}\">{$v4a0dc59dd475d7fbeadc872e24f24dd0}</a></p>", $v5c18ef72771564b7f43c497dc507aeab);}}$v5c18ef72771564b7f43c497dc507aeab .= "\n";$v980da98409d058c365664ff7ea33dd6b = [];foreach ($v8836d156dbd01a6c0776b086b0ff3b83 as $v350e6018b5636ab1e90720fed9694ccf) {if (mb_strlen($v350e6018b5636ab1e90720fed9694ccf) <= 1) {continue;}$v1798c7d9bd5a5d637ead47154f0d36e3 = $v5c18ef72771564b7f43c497dc507aeab;$vf3b462d93b24cb0538f5d864546bc3e0 = language_morph::get_word_base($v350e6018b5636ab1e90720fed9694ccf);$vf3b462d93b24cb0538f5d864546bc3e0 = preg_quote($vf3b462d93b24cb0538f5d864546bc3e0, '/');$vd6f81d33de1672f67ef047aa89b6848b = "/([^\.^\?^!^<^>.]*)$vf3b462d93b24cb0538f5d864546bc3e0([^\.^\?^!^<^>.]*)[!\.\?\n]/imu";if (preg_match($vd6f81d33de1672f67ef047aa89b6848b, $v1798c7d9bd5a5d637ead47154f0d36e3, $v1798c7d9bd5a5d637ead47154f0d36e3)) {$v980da98409d058c365664ff7ea33dd6b[] = $v1798c7d9bd5a5d637ead47154f0d36e3[0];}}$v980da98409d058c365664ff7ea33dd6b = array_unique($v980da98409d058c365664ff7ea33dd6b);$vcb114fb1f5594c74601a4d8a142d932d = '';foreach ($v980da98409d058c365664ff7ea33dd6b as $v6438c669e0d0de98e6929c2cc0fac474) {foreach ($v8836d156dbd01a6c0776b086b0ff3b83 as $v350e6018b5636ab1e90720fed9694ccf) {$vf3b462d93b24cb0538f5d864546bc3e0 = language_morph::get_word_base($v350e6018b5636ab1e90720fed9694ccf);$vf3b462d93b24cb0538f5d864546bc3e0 = preg_quote($vf3b462d93b24cb0538f5d864546bc3e0, '/');$v1dcb47f8fb7fc589f094bc7707d8ffa7 = "/([^ ^.^!^\?.]*)($vf3b462d93b24cb0538f5d864546bc3e0)([^ ^.^!^\?.]*)/imu";$v6438c669e0d0de98e6929c2cc0fac474 = preg_replace($v1dcb47f8fb7fc589f094bc7707d8ffa7, $v6920626369b1f05844f5e3d6f93b5f6e . "\\1\\2\\3" . $v4de1b7a4dc53e4a84c25ffb7cdb580ee, $v6438c669e0d0de98e6929c2cc0fac474);}if ($v6438c669e0d0de98e6929c2cc0fac474) {$vcb114fb1f5594c74601a4d8a142d932d .= '<p>' . $v6438c669e0d0de98e6929c2cc0fac474 . '</p>';}}if (!$vcb114fb1f5594c74601a4d8a142d932d) {preg_match("/([^\.^!^\?.]*)([\.!\?]*)/im", $v5c18ef72771564b7f43c497dc507aeab, $vcb114fb1f5594c74601a4d8a142d932d);$vcb114fb1f5594c74601a4d8a142d932d = "<p>{$vcb114fb1f5594c74601a4d8a142d932d[0]}</p>";}return $vcb114fb1f5594c74601a4d8a142d932d;}public function unindex_items($v7552cd149af7495ee7d8225974e50f80) {$v7552cd149af7495ee7d8225974e50f80 = (int) $v7552cd149af7495ee7d8225974e50f80;$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$vac5c74b64b4b8352ef2f181affb5ac2a = "DELETE FROM cms3_search WHERE rel_id = '{$v7552cd149af7495ee7d8225974e50f80}'";$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);$vac5c74b64b4b8352ef2f181affb5ac2a = "DELETE FROM cms3_search_index WHERE rel_id = '{$v7552cd149af7495ee7d8225974e50f80}'";$v4717d53ebfdfea8477f780ec66151dcb->query($vac5c74b64b4b8352ef2f181affb5ac2a);return true;}public function index_items($v7552cd149af7495ee7d8225974e50f80) {$vb81ca7c0ccaa77e7aa91936ab0070695 = umiHierarchy::getInstance();$v268184c12df027f536154d099d497b31 = $vb81ca7c0ccaa77e7aa91936ab0070695->getChildrenTree($v7552cd149af7495ee7d8225974e50f80, true, true, 99);$v6a7f245843454cf4f28ad7c5e2572aa2 = [$v7552cd149af7495ee7d8225974e50f80];$this->expandArray($v268184c12df027f536154d099d497b31, $v6a7f245843454cf4f28ad7c5e2572aa2);foreach($v6a7f245843454cf4f28ad7c5e2572aa2 as $v7552cd149af7495ee7d8225974e50f80) {$this->index_item($v7552cd149af7495ee7d8225974e50f80);}}public function calculateIDF($vd1f5ee0092ec47708f200415f2a89717) {static $vf68d7efaad2efd0f8c0c965a34fbe5e1 = false;$vd1f5ee0092ec47708f200415f2a89717 = (int) $vd1f5ee0092ec47708f200415f2a89717;$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();if ($vf68d7efaad2efd0f8c0c965a34fbe5e1 === false) {$vac5c74b64b4b8352ef2f181affb5ac2a = 'SELECT COUNT(`rel_id`) FROM `cms3_search`';$result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ROW);$v8277e0910d750195b448797616e091ad = 0;if ($result->length() > 0) {$v54851b009c5c647ca3e77cc517b8c76c = $result->fetch();$v8277e0910d750195b448797616e091ad = (int) array_shift($v54851b009c5c647ca3e77cc517b8c76c);}$vac5c74b64b4b8352ef2f181affb5ac2a = "SELECT COUNT(`rel_id`) FROM `cms3_search_index` WHERE `word_id` = {$vd1f5ee0092ec47708f200415f2a89717}";$result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ROW);$v1aabac6d068eef6a7bad3fdf50a05cc8 = 1;if ($result->length() > 0) {$v54851b009c5c647ca3e77cc517b8c76c = $result->fetch();$v1aabac6d068eef6a7bad3fdf50a05cc8 = (int) array_shift($v54851b009c5c647ca3e77cc517b8c76c);}$vf68d7efaad2efd0f8c0c965a34fbe5e1 = log($v8277e0910d750195b448797616e091ad / $v1aabac6d068eef6a7bad3fdf50a05cc8);}return $vf68d7efaad2efd0f8c0c965a34fbe5e1;}public function suggestions($vb45cffe084dd3d20d928bee85e7b0f21, $vaa9f73eea60a006820d0f8768bc8a3fc = 10) {$vb45cffe084dd3d20d928bee85e7b0f21 = trim($vb45cffe084dd3d20d928bee85e7b0f21);if (!$vb45cffe084dd3d20d928bee85e7b0f21) {return false;}$vb45cffe084dd3d20d928bee85e7b0f21 = mb_strtolower($vb45cffe084dd3d20d928bee85e7b0f21);$va04202c712aa415f47dbacb817a60397 = str_split('йцукенгшщзхъфывапролджэячсмитьбю');$v74e6a8b111ea7da1a7d0a596f4c35208 = str_split('qwertyuiop[]asdfghjkl;\'zxcvbnm,.');$v9c1b200500ea38c658ac7c81b10e85d2 = iconv('UTF-8', 'CP1251', $vb45cffe084dd3d20d928bee85e7b0f21);$ve39cf8a95dc90270161317376387b25a = iconv('CP1251', 'UTF-8', str_replace($va04202c712aa415f47dbacb817a60397, $v74e6a8b111ea7da1a7d0a596f4c35208, $v9c1b200500ea38c658ac7c81b10e85d2));$v67ae3d093b55e92227d0861222db0c6d = iconv('CP1251', 'UTF-8', str_replace($v74e6a8b111ea7da1a7d0a596f4c35208, $va04202c712aa415f47dbacb817a60397, $v9c1b200500ea38c658ac7c81b10e85d2));$vd0c03a4c136b717b6ebc603966e26755 = ($ve39cf8a95dc90270161317376387b25a != $vb45cffe084dd3d20d928bee85e7b0f21) ? $ve39cf8a95dc90270161317376387b25a : $v67ae3d093b55e92227d0861222db0c6d;$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection('search');$vb45cffe084dd3d20d928bee85e7b0f21 = $v4717d53ebfdfea8477f780ec66151dcb->escape($vb45cffe084dd3d20d928bee85e7b0f21);$vd0c03a4c136b717b6ebc603966e26755 = $v4717d53ebfdfea8477f780ec66151dcb->escape($vd0c03a4c136b717b6ebc603966e26755);$vaa9f73eea60a006820d0f8768bc8a3fc = (int) $vaa9f73eea60a006820d0f8768bc8a3fc;$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT `siw`.`word` as `word`, COUNT(`si`.`word_id`) AS `cnt`
	FROM
		`cms3_search_index_words` `siw`,
		`cms3_search_index` `si`
	WHERE
		(
			`siw`.`word` LIKE '{$vb45cffe084dd3d20d928bee85e7b0f21}%' OR
			`siw`.`word` LIKE '{$vd0c03a4c136b717b6ebc603966e26755}%'
		) AND
		`si`.`word_id` = `siw`.`id`
	GROUP BY
		`siw`.`id`
	ORDER BY SUM(`si`.`tf`) DESC
	LIMIT {$vaa9f73eea60a006820d0f8768bc8a3fc}
SQL;   return $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);}public function getIndexWordList() {$vac5c74b64b4b8352ef2f181affb5ac2a = 'SELECT `word` FROM `cms3_search_index_words`';$result = ConnectionPool::getInstance()    ->getConnection()    ->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ASSOC);$v1d292709698108f1598271ac25ab742e = [];foreach ($result as $vf1965a857bc285d26fe22023aa5ab50d) {$v1d292709698108f1598271ac25ab742e[] = $vf1965a857bc285d26fe22023aa5ab50d['word'];}return $v1d292709698108f1598271ac25ab742e;}public function getIndexList() {$vac5c74b64b4b8352ef2f181affb5ac2a = 'SELECT `rel_id`, `weight`, `word_id`, `tf` FROM `cms3_search_index`';$result = ConnectionPool::getInstance()    ->getConnection()    ->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ASSOC);$v0ddb9f30e5f4b84581595009098297a7 = [];foreach ($result as $vf1965a857bc285d26fe22023aa5ab50d) {$v0ddb9f30e5f4b84581595009098297a7[] = [     'rel_id' => $vf1965a857bc285d26fe22023aa5ab50d['rel_id'],     'weight' => $vf1965a857bc285d26fe22023aa5ab50d['weight'],     'word_id' => $vf1965a857bc285d26fe22023aa5ab50d['word_id'],     'tf' => $vf1965a857bc285d26fe22023aa5ab50d['tf'],    ];}return $v0ddb9f30e5f4b84581595009098297a7;}private function expandArray($v47c80780ab608cc046f2a6e6f071feb6, &$result) {if ($result === null) {$result = [];}foreach ($v47c80780ab608cc046f2a6e6f071feb6 as $vb80bb7740288fda1f201890375a60c8f => $vadce578d04ed03c31f6ac59451fcf8e4) {$result[] = $vb80bb7740288fda1f201890375a60c8f;$this->expandArray($vadce578d04ed03c31f6ac59451fcf8e4, $result);}}private function isAllowed(iUmiHierarchyElement $v8e2dcfd7e7e24b1ca76c1193f645902b) {$va18b1057c4327b9cc46abc9fcf952bd8 = $v8e2dcfd7e7e24b1ca76c1193f645902b->getIsDeleted();$vdcc4574d23469027426e6635d0974e6d = $v8e2dcfd7e7e24b1ca76c1193f645902b->getValue('is_unindexed');$vd96263a44289d6e7cb457eda385d5124 = !$v8e2dcfd7e7e24b1ca76c1193f645902b->getIsActive();if ($va18b1057c4327b9cc46abc9fcf952bd8 || $vdcc4574d23469027426e6635d0974e6d || $vd96263a44289d6e7cb457eda385d5124) {return false;}$v863224e2c6a58ded021c2cedcf75ef0a = (bool) mainConfiguration::getInstance()    ->get('modules', 'search.allow-virtual-copies');if ($v863224e2c6a58ded021c2cedcf75ef0a) {return true;}return $v8e2dcfd7e7e24b1ca76c1193f645902b->isOriginal();}public function elementIsReindexed($v7057e8409c7c531a1a6e9ac3df4ed549, $v5fa40b2485d1096a170d2d7ecd0f7030) {$v7057e8409c7c531a1a6e9ac3df4ed549 = (int) $v7057e8409c7c531a1a6e9ac3df4ed549;$v5fa40b2485d1096a170d2d7ecd0f7030 = (int) $v5fa40b2485d1096a170d2d7ecd0f7030;$v4717d53ebfdfea8477f780ec66151dcb = ConnectionPool::getInstance()->getConnection();$vac5c74b64b4b8352ef2f181affb5ac2a = <<<SQL
SELECT `rel_id` FROM `cms3_search` WHERE `rel_id` = '{$v7057e8409c7c531a1a6e9ac3df4ed549}' AND `indextime` > '{$v5fa40b2485d1096a170d2d7ecd0f7030}' LIMIT 0,1
SQL;   $result = $v4717d53ebfdfea8477f780ec66151dcb->queryResult($vac5c74b64b4b8352ef2f181affb5ac2a);$result->setFetchType(IQueryResult::FETCH_ROW);return $result->length() > 0;}}